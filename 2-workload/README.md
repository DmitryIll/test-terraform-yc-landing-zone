 # Создание облака полезной нагрузки (2-workload)

Задача этого модуля - продемонстрировать пример создания и наполнения облака полезной нагрузки `workload` с применением модулей из [библиотеки модулей](https://github.com/terraform-yc-modules).

## Пререквизиты
- развернуто и настроено облако `bootstrap`.

## Пошаговая инструкция

> [!WARNING] Внимание
> Ресурсы, создаваемые в этом примере, тарифицируются.

### Создание облака `workload`
  > Примеры команд выполняются в каталоге `0-bootstrap`, профиль YC CLI настроен на пользователя с правами `resource-manager.admin` на организацию.
- [ ] Скопируйте файл с описанием облака `../2-workload/for_bootstrap/cloud_workload.tf` в каталог `0-bootstrap`

```sh
cp ../2-workload/for_bootstrap/cloud_workload.tf .
```

- [ ] Инициализируйте значение переменной `workload_cloud_admins` - это список учетных записей (Yandex ID) будущих администраторов облака `workload`. Они будут добавлены в группу `workload-owner`, для которой назначается роль `resource-manager.clouds.owner` на облако `workload`.
  - Задать значение можно в файле `terraform.tfvars` в каталоге `0-bootstrap` (на этом этапе мы работаем с конфигурацией в каталоге `0-bootstrap`), либо через переменную окружения `TF_VAR_workload_cloud_admins`.

- [ ] Выполните повторную инициализацию провайдера Terraform. Это нужно на случай, если в описании облака `workload` используются ранее не загруженные провайдеры.

```sh
terraform init
```

- [ ] Проверьте корректность конфигурации и предполагаемый план выполнения. Это помогает выявить возможные ошибки не дожидаясь фактического применения

```sh
terraform validate
terraform plan
```

- [ ] Примените конфигурацию из каталога `0-bootstrap`

```sh
terraform apply 
```

- [ ] Из вывода скопируйте значения `workload_cloud_id` и `id` каталога `workload` (из списка `workload_cloud_folders`), которые понадобятся на этапе наполнения облака.

> Технически вы дополнили конфигурацию `0-bootstrap` описанием облака `workload` без наполнения, доустановили недостающие провайдеры и применили конфигурацию от имени субъекта с с правами `resource-manager.admin`.

После применения конфигурации в организации будут созданы:
- **Облако** `workload`, содержащее **каталог** `workload`;
- **Группа** `workload-owner` с ролями
  - `resource-manager.clouds.owner` на облако `workload`,
  - `organization-manager.groups.memberAdmin` на саму себя - для возможности добавлять новых субъектов без привлечения администраторов организации.
- Указанные пользователи добавлены в группу `workload-owner`.

### Наполнение облака `workload`
  >Примеры команд далее выполняются в каталоге `2-workload`, профиль YC CLI настроен на пользователя или сервисный акаунт с правами `resource-manager.clouds.owner` на облако `workload`.
- [ ] Инициализируйте провайдера Terraform в каталоге `2-workload`

```sh
terraform init
```

- [ ] В файле `terraform.tfvars` заполните значения переменных `cloud_id` и `folder_id` значениями полученными на этапе создания облака `workload`.

- [ ] Проверьте корректность конфигурации и предполагаемый план выполнения. Это помогает выявить возможные ошибки не дожидаясь фактического применения

```sh
terraform validate
terraform plan
```

> Вы можете по своему усмотрению изменить содержимое каталога `2-workload`, добавить или удалить ресурсы. Все что описано в файле `main.tf` - это пример наполнения облака `workload`.

- [ ] Примените конфигурацию из каталога `2-workload`.

```sh
terraform apply
```

После применения данной конфигурации в облаке `workload`, в каталоге `workload` будут созданы:
- сеть
- кластер Kubernetes
- кластер PostgreSQL
- вспомогательные ресурсы, создаваемые автоматически

### Удаление облака `workload`
Действуйте в обратном порядке.
1. В каталоге `2-workload` от пользователя - члена группы `workload-owner` выполните
```sh
terraform destroy
```
Оцените описание предполагаемых действий, подтвердите намерение удалить ресурсы (напечатать `yes`). Будет удалено наполнение облака `workload`.

2. В каталоге `0-bootstrap` удалите файл `cloud_workload.tf`.
3. В каталоге `0-bootstrap` от пользователя с правами `resource-manager.admin` выполните
```sh
terraform apply
```
> [!WARNING] Важно
> Последняя команда именно `terraform apply`, а не `terraform destroy`, поскольку удаление облака `workload` произойдет как приведение конфигурации в `0-bootstrap` к текущему описанию, где больше нет файла с описанием облака `workload`.  
> Если выполнить `terraform destroy`, то удалится вся конфигурация, включая облако `bootstrap` и все другие облака, созданные аналогично.

Оцените описание предполагаемых действий, подтвердите намерение удалить ресурсы (напечатать `yes`). Будет удалено само облако `workload` (со всеми оставшимися в нем ресурсами) и группа `workload-owner`.
