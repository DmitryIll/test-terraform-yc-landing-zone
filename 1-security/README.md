# Создание облака для реализации ИБ уровня организации (1-security)

Основня задача этого шага - создать облако, для размещения ресурсов и сервисов, необходимых для реализации мер информационной безопасности.

>С точки зрения общего подхода, облако "security" так же является полезной нагрузкой, однако, описано отдельно, чтобы продемонстрировать рекомендованный набор сервисов и применимые настройки.

## Пререквизиты
- развернуто и настроено облако `bootstrap`.

## Пошаговая инструкция

### Создание облака `security`.
  >Примеры команд выполняются в каталоге `0-bootstrap`, профиль YC CLI настроен на пользователя с правами `resource-manager.admin` на организацию.

- [ ] Скопируйте файл с описанием облака `../1-security/for_bootstrap/cloud_security.tf` в каталог `0-bootstrap`
```sh
cp ../1-security/for_bootstrap/cloud_security.tf .
```
- [ ] Инициализируйте значение переменной `security_cloud_admins` - это список учетных записей (Yandex ID) будущих администраторов облака `security`. Они будут добавлены в группу `security`, для которой назначается роль `resource-manager.clouds.owner` на облако `security`.
  - Задать значение можно в файле `terraform.tfvars` в каталоге `0-bootstrap` (на этом этапе мы работаем с конфигурацией в каталоге `0-bootstrap`), либо через переменную окружения `TF_VAR_security_cloud_admins`.

- [ ] Выполните повторную инициализацию провайдера Terraform. Это нужно на случай, если в описании облака `security` используются ранее не загруженные провайдеры.

```sh
terraform init
```

- [ ] Проверьте корректность конфигурации и предполагаемый план выполнения. Это помогает выявить возможные ошибки не дожидаясь фактического применения

```sh
terraform validate
terraform plan
```

- [ ] Примените конфигурацию из каталога `0-bootstrap`

```sh
terraform apply 
```

- [ ] Из вывода скопируйте значения `security_cloud_id` и `id` каталога `audit` (из списка `security_cloud_folders`), которые понадобятся на этапе наполнения облака.

> Технически вы дополнили конфигурацию `0-bootstrap` описанием облака `security` без наполнения, доустановили недостающие провайдеры и применили конфигурацию от имени субъекта с правами `resource-manager.admin`.

После применения конфигурации в организации будут созданы:
- **Облако** `security`, содержащее **каталог** `audit`;
- **Группа** `secutiry` с ролями
  - `resource-manager.clouds.owner` на облако `secutiry`,
  - `organization-manager.groups.memberAdmin` на саму себя и на группу `auditors` - для возможности добавлять новых субъектов без привлечения администраторов организации.
  - Используйте эту группу для включения в нее паспортных или федеративных учетных записей администраторов информационной безопасности.
- **Группа** `auditors` с ролью `auditor` на всю организацию. Используйте эту группу для для включения в нее паспортных или федеративных учетных записей аудиторов (просмотр без возможности изменения всех ресурсов облака).
- **Сервисный акаунт** `audit-trails-sa` с ролями
  - `audit-trails.viewer` на всю организацию для сбора трейлов аудита.
- Указанные пользователи добавлены в группу `secutiry`.

### Наполнение облака `secutiry`
  >Примеры команд далее выполняются в каталоге `1-secutiry`, профиль YC CLI настроен на пользователя или сервисный акаунт с правами `resource-manager.clouds.owner` на облако `secutiry`.

- [ ] Инициализируйте провайдера Terraform в каталоге `1-secutiry`

```sh
terraform init
```

- [ ] В файле `terraform.tfvars` заполните значения переменных `cloud_id` и `folder_id` значениями полученными на этапе создания облака `security`.

- [ ] По желанию можете изменить конфигурацию Audit Trails, кототый описан в файле `main.tf`.
  - `destination_type` - тип хранилища для сохранения трейлов аудита.
  - `management_events_filter` - фильтр событий уровня управления, которые будут сохранены в трейле аудита.
  - `data_events_filter` - фильтр событий уроня данных, которые будут сохранены в трейле аудита.

- [ ] Проверьте корректность конфигурации и предполагаемый план выполнения. Это помогает выявить возможные ошибки не дожидаясь фактического применения

```sh
terraform validate
terraform plan
```

- [ ] Примените конфигурацию из каталога `1-secutiry`.

```sh
terraform apply
```

После применения данной конфигурации в облаке `secutiry`, в каталоге `audit` будут созданы:
- **бакет** `audit-****` (вместо **** - 4 случайных символа для обеспечения уникальности имени бакета) для сохранения трейлов аудита.
- **трейл аудита** `org-trail`, настроенный для сбора событий уровня конфигурации всех ресурсов организации и сохранения их в объектное хранилище (конфигурация по-умолчанию описана в файле `main.tf`).
